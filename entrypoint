#!/bin/bash

set -e

DATA_DIR=${DATA_DIR:-/data}

mkdir -p ${DATA_DIR}

OPTS=( "--max-workers=${MAX_WORKERS:-1}" )

if [ -n "$PROMETHEUS_URL" ]; then
    OPTS+=( "--prometheus-url=${PROMETHEUS_URL}" )
fi

function cleanup()
{
    pkill python3
    service nginx stop
    exit 0
}

trap cleanup HUP INT

while true; do
    if ! service nginx status &>/dev/null; then
        echo Starting nginx...
        service nginx start
    fi

    python3 krr.py simple ${OPTS[@]} -f json \
        | sed -ne '/^{/,/^}/p' \
        | tr -d '\n' \
        | jq -r > $DATA_DIR/result.json

    python3 krr2prom.py <$DATA_DIR/result.json >$DATA_DIR/.result.prom

    mv $DATA_DIR/.result.prom $DATA_DIR/result.prom
    n=$(wc -l $DATA_DIR/result.prom)
    echo -n Generated $n metrics in $DATA_DIR/result.prom

    sleep ${SLEEP:-1m}
done
