#!/bin/bash

set -e

DATA_DIR=${DATA_DIR:-/data}
SCAN_FREQUENCY=${SCAN_FREQUENCY:-1h}
OPTS=( "--max-workers=${MAX_WORKERS:-1}" )

if [ -n "$PROMETHEUS_URL" ]; then
    OPTS+=( "--prometheus-url=${PROMETHEUS_URL}" )
fi

function cleanup()
{
    {
        echo Shutting down
        pkill python3
        service nginx stop
    } 2>&1 | log
    exit 0
}

function log()
{
    while read line; do
        echo '{"time":"'$(date)'","message":"'${line}'"}'
    done
}

{
    echo Scan frequency: $SCAN_FREQUENCY
    echo Max workers: $MAX_WORKERS
    echo Prometheus URL: ${PROMETHEUS_URL:-<auto-discovery>}
} 2>&1 | log

trap cleanup HUP INT

mkdir -p ${DATA_DIR}
nginx -t 2>&1 | log

while true; do
    if ! service nginx status &>/dev/null; then
        service nginx start 2>&1 | log
    fi

    echo Starting KRR 2>&1 | log
    python3 krr.py simple ${OPTS[@]} -f json \
        | sed -ne '/^{/,/^}/p' \
        | tr -d '\n' \
        | jq -r > $DATA_DIR/result.json

    python3 krr2prom.py <$DATA_DIR/result.json >$DATA_DIR/.result.prom

    mv $DATA_DIR/.result.prom $DATA_DIR/result.prom
    n=$(wc -l $DATA_DIR/result.prom)
    echo Generated $n metrics in $DATA_DIR/result.prom 2>&1 | log

    sleep $SCAN_FREQUENCY
done
